<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Pulse | 團隊出勤紀錄</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/batch_style.css">
    <link rel="stylesheet" href="css/settings_style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-background">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="screen active">
            <div class="glass-panel login-panel">
                <div class="brand">
                    <i class="fa-solid fa-bolt pulse-icon"></i>
                    <h1>Office Pulse</h1>
                </div>
                <p class="subtitle">同步你的出勤狀態，凝聚團隊向心力。</p>

                <form id="login-form">
                    <div class="input-group">
                        <i class="fa-regular fa-user"></i>
                        <input type="text" id="username" placeholder="帳號" required value="Alex">
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="password" placeholder="密碼" value="password">
                    </div>
                    <button type="submit" class="btn-primary">登入 <i class="fa-solid fa-arrow-right"></i></button>
                </form>

                <div class="demo-hint">
                    <small>試試使用 "Alex", "Sam", 或 "Jordan" 登入</small>
                </div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen">
            <header class="top-bar">
                <div class="brand-small">
                    <i class="fa-solid fa-bolt pulse-icon-small"></i>
                    <span>Office Pulse</span>
                </div>
                <div style="flex:1"></div>
                <button id="stats-btn" class="btn-icon" style="margin-right: 1rem;">
                    <i class="fa-solid fa-chart-pie"></i> 報表
                </button>
                <button id="btn-app-header" class="btn-icon" style="margin-right: 1rem;" title="申請作業"
                    onclick="if(window.openApplicationsModal) window.openApplicationsModal()"><i
                        class="fa-solid fa-file-signature"></i> 申請</button>
                <div class="user-profile">
                    <span id="current-user-name">Alex M.</span>
                    <div class="avatar-small" id="current-user-avatar">AM</div>
                    <button id="settings-btn" class="btn-icon" title="設定"
                        onclick="if(window.openSettings) window.openSettings();"><i
                            class="fa-solid fa-gear"></i></button>
                    <button id="logout-btn" class="btn-icon" title="登出"><i
                            class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </header>

            <main class="dashboard-grid">
                <!-- Main Calendar Section -->
                <section class="calendar-section glass-panel">
                    <div class="calendar-header">
                        <!-- Perpetual Calendar Controls -->
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button id="calendar-prev-btn" class="btn-icon"
                                style="background:none; border:none; color:#64748b; cursor:pointer; font-size: 0.9rem;"><i
                                    class="fa-solid fa-chevron-left"></i> 上月</button>
                            <select id="calendar-year-select" class="form-input"
                                style="width:auto; font-size:1.2rem; font-weight:bold; padding:5px 10px;"></select>
                            <select id="calendar-month-select" class="form-input"
                                style="width:auto; font-size:1.2rem; font-weight:bold; padding:5px 10px;">
                                <option value="0">1月</option>
                                <option value="1">2月</option>
                                <option value="2">3月</option>
                                <option value="3">4月</option>
                                <option value="4">5月</option>
                                <option value="5">6月</option>
                                <option value="6">7月</option>
                                <option value="7">8月</option>
                                <option value="8">9月</option>
                                <option value="9">10月</option>
                                <option value="10">11月</option>
                                <option value="11">12月</option>
                            </select>
                            <button id="calendar-next-btn" class="btn-icon"
                                style="background:none; border:none; color:#64748b; cursor:pointer; font-size: 0.9rem;">下月
                                <i class="fa-solid fa-chevron-right"></i></button>
                            <button id="today-btn" class="btn-text"
                                style="font-size:0.9rem; border: 1px solid #94a3b8; border-radius: 20px; padding: 4px 12px;">回到今天</button>
                        </div>

                        <div class="calendar-controls" style="display:flex; gap:10px; align-items:center;">
                            <!-- Batch Mode Toggle -->
                            <button id="batch-mode-btn" class="btn-icon" title="開啟多選模式，一次編輯多天"
                                style="border-radius:20px; padding: 0.4rem 1rem; font-size:0.85rem;">
                                <i class="fa-regular fa-square-check"></i> 多選模式: <span id="batch-status">關</span>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid-header">
                        <div>日</div>
                        <div>一</div>
                        <div>二</div>
                        <div>三</div>
                        <div>四</div>
                        <div>五</div>
                        <div>六</div>
                    </div>
                    <div id="calendar-days" class="calendar-days">
                        <!-- Days will be injected here -->
                    </div>
                </section>

                <!-- Sidebar: Today's Pulse -->
                <aside class="sidebar-section">
                    <!-- Status Widget (Right Sidebar) -->
                    <aside class="status-widget glass-panel">
                        <div class="widget-header">
                            <h3>我的狀態：<span class="highlight-text">今天</span></h3>

                            <!-- Clock In/Out Section -->
                            <div class="clock-section"
                                style="background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div id="clock-status-text"
                                        style="font-size: 0.85rem; color: #64748b; font-weight: 600;">尚未打卡</div>
                                    <div id="clock-time-display"
                                        style="font-size: 1.1rem; color: #0f172a; font-weight: 700; font-family: monospace;">
                                        --:--</div>
                                </div>
                                <button id="btn-clock-action" class="btn-primary"
                                    style="padding: 0.5rem 1rem; font-size: 0.9rem; background: #3b82f6;">
                                    <i class="fa-solid fa-stopwatch"></i> 上班
                                </button>
                            </div>

                            <input type="text" id="day-event-input" class="event-input-small"
                                placeholder="＋ 新增公司大記事 (如: 客戶來訪)...">
                        </div>

                        <!-- User Selector for Admin Mode (Hidden by default) -->
                        <div id="admin-user-selector" class="form-group hidden" style="margin-bottom:1rem;">
                            <label style="font-size:0.85rem; color:#64748b;">幫誰排班？</label>
                            <select id="target-user-select" class="form-input" style="padding:0.4rem;">
                                <!-- Injected -->
                            </select>
                        </div>

                        <!-- Main Status Buttons (Text) -->
                        <div class="status-buttons" style="grid-template-columns: repeat(5, 1fr);">
                            <button class="status-btn office" data-status="office" title="進辦公室">
                                <span>辦公室</span>
                            </button>
                            <button class="status-btn remote" data-status="remote" title="居家辦公">
                                <span>居家</span>
                            </button>
                            <button class="status-btn trip" data-status="trip" title="出差">
                                <span>出差</span>
                            </button>
                            <button class="status-btn away" data-status="away" title="請假">
                                <span>請假</span>
                            </button>
                            <button class="status-btn other" onclick="updateSidebar('other')" data-status="other"
                                title="其他">
                                <span>會議</span>
                            </button>
                        </div>

                        <!-- Dynamic Sub-Options (Chips) -->
                        <div id="sub-options-container" class="sub-options-container hidden">
                            <!-- Injected by JS -->
                        </div>

                        <!-- Time Configuration -->
                        <div class="time-config-container">
                            <label class="check-group">
                                <input type="checkbox" id="all-day-check" checked>
                                <span>全天行程</span>
                            </label>
                            <div class="time-inputs disabled" id="time-inputs-wrapper"
                                style="display: flex; gap: 5px; align-items: center;">
                                <div style="display:flex; gap:2px;">
                                    <select id="start-hour" class="form-input"
                                        style="width:50px; padding:2px;"></select>
                                    <span>:</span>
                                    <select id="start-min" class="form-input" style="width:50px; padding:2px;"></select>
                                </div>
                                <span style="margin:0 5px;">至</span>
                                <div style="display:flex; gap:2px;">
                                    <select id="end-hour" class="form-input" style="width:50px; padding:2px;"></select>
                                    <span>:</span>
                                    <select id="end-min" class="form-input" style="width:50px; padding:2px;"></select>
                                </div>
                            </div>
                        </div>

                        <div class="note-container">
                            <div id="location-inputs-container" style="display:none; gap: 5px; margin-bottom: 8px;">
                                <input type="text" id="status-loc-start" placeholder="起點 (如: 台北)" style="flex:1;">
                                <span style="align-self:center;">-</span>
                                <input type="text" id="status-loc-end" placeholder="終點 (如: 高雄)" style="flex:1;">
                            </div>
                            <div id="meeting-inputs-container"
                                style="display:none; gap: 5px; margin-bottom: 8px; flex-direction: column;">
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="status-meet-link" placeholder="會議連結 (Google Meet)"
                                        style="flex:1;">
                                </div>
                                <div
                                    style="background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px; margin-top: 5px;">
                                    <div
                                        style="font-weight:600; margin-bottom:5px; font-size:0.9rem; display:flex; justify-content:space-between;">
                                        <span>參與同仁</span>
                                        <label style="cursor:pointer; color:#3b82f6;"><input type="checkbox"
                                                id="meet-check-all"> 全選</label>
                                    </div>
                                    <div id="meet-attendees-list"
                                        style="display:flex; flex-wrap:wrap; gap:10px; max-height:150px; overflow-y:auto;">
                                        <!-- Injected User Checkboxes -->
                                    </div>
                                </div>
                            </div>
                            <input type="text" id="status-note" placeholder="備註 (選填)">
                            <button id="add-status-btn" class="btn-add"><i class="fa-solid fa-plus"></i> 新增行程</button>
                        </div>

                        <!-- My Current Day Segments -->
                        <ul id="my-segments-list" class="my-segments-list">
                            <!-- Segments injected here -->
                        </ul>

                        <!-- Team Status List -->
                        <div class="team-list-panel"
                            style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e2e8f0;">
                            <h3>今日團隊動態 <span class="live-indicator">● 即時</span></h3>

                            <div class="status-group">
                                <h4 class="group-title office-title">🏢 辦公室 <span class="count"
                                        id="count-office">0</span>
                                </h4>
                                <ul class="user-list" id="list-office"></ul>
                            </div>

                            <div class="status-group">
                                <h4 class="group-title remote-title">🏠 居家辦公 <span class="count"
                                        id="count-remote">0</span>
                                </h4>
                                <ul class="user-list" id="list-remote"></ul>
                            </div>

                            <div class="status-group">
                                <h4 class="group-title trip-title">💼 出差 <span class="count" id="count-trip">0</span>
                                </h4>
                                <ul class="user-list" id="list-trip"></ul>
                            </div>

                            <div class="status-group">
                                <h4 class="group-title away-title">🌴 請假 <span class="count" id="count-away">0</span>
                                </h4>
                                <ul class="user-list" id="list-away"></ul>
                            </div>

                            <div class="status-group">
                                <h4 class="group-title other-title">⚪ 會議 <span class="count" id="count-other">0</span>
                                </h4>
                                <ul class="user-list" id="list-other"></ul>
                            </div>
                        </div>
                    </aside>
            </main>
        </div>

        <!-- Stats Modal -->
        <div id="stats-modal" class="modal-overlay" style="align-items: flex-start; padding-top: 2rem;">
            <div class="modal-panel"
                style="max-width: 1200px; width: 95%; height: 90vh; display: flex; flex-direction: column; padding: 0;">
                <div class="modal-header" style="flex-shrink: 0; padding: 1.5rem;">
                    <h2>月度出勤總覽</h2>
                    <button class="btn-close" id="close-stats-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="modal-body" style="flex-grow: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem 1.5rem;">
                    <div class="modal-tabs"
                        style="position: sticky; top: 0; background: white; z-index: 10; padding-top: 10px; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <button class="tab-btn active" id="tab-btn-summary">統計總表</button>
                        <button class="tab-btn" id="tab-btn-detail">詳細考勤紀錄</button>
                    </div>

                    <!-- Summary View -->
                    <div id="stats-summary-view" class="stats-table-container">
                        <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
                            <label>月份統計：</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="month" id="summary-month-select" class="form-input"
                                    style="width: auto; padding: 4px 8px;">
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('summary-month-select', -1)">上月</button>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('summary-month-select', 0)">本月</button>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('summary-month-select', 1)">下月</button>
                            </div>
                            <button id="btn-query-summary" class="btn-primary"
                                style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                <i class="fa-solid fa-magnifying-glass"></i> 查詢
                            </button>
                        </div>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>同仁</th>
                                    <th>🏢 辦公室</th>
                                    <th>🏠 居家</th>
                                    <th>💼 出差</th>
                                    <th>🌴 請假</th>
                                    <th>出勤率 (Office)</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Detail View -->
                    <div id="stats-detail-view" class="stats-table-container hidden">
                        <div
                            style="margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <label>查看同仁：</label>
                            <select id="detail-user-select" class="form-input"
                                style="width: auto; padding: 4px 8px; min-width: 120px;">
                                <!-- Injected Users -->
                            </select>
                            <label style="margin-left: 10px;">月份：</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="month" id="detail-month-select" class="form-input"
                                    style="width: auto; padding: 4px 8px;">
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('detail-month-select', -1)">上月</button>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('detail-month-select', 0)">本月</button>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem;"
                                    onclick="changeMonth('detail-month-select', 1)">下月</button>
                            </div>
                            <button id="btn-query-detail" class="btn-primary"
                                style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-left: 10px;">
                                <i class="fa-solid fa-magnifying-glass"></i> 查詢
                            </button>
                        </div>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>星期</th>
                                    <th>狀態</th>
                                    <th>上班打卡</th>
                                    <th>下班打卡</th>
                                    <th>工時</th>
                                </tr>
                            </thead>
                            <tbody id="detail-table-body">
                                <!-- Injected Detail Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal-overlay" style="align-items: flex-start; padding-top: 2rem;">
            <div class="modal-panel"
                style="max-width: 800px; width: 95%; height: 90vh; display: flex; flex-direction: column; padding: 0;">
                <div class="modal-header" style="flex-shrink: 0; padding: 1.5rem;">
                    <h2>設定中心</h2>
                    <button class="btn-close" id="close-settings-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="modal-body" style="flex-grow: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem 1.5rem;">
                    <div class="modal-tabs"
                        style="position: sticky; top: 0; background: white; z-index: 10; padding-top: 10px; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <button class="tab-btn active" data-tab="tab-profile">個人設定</button>
                        <button class="tab-btn" data-tab="tab-team" id="tab-btn-team">團隊管理</button>
                        <button class="tab-btn" data-tab="tab-reports" id="tab-btn-reports"
                            style="display:none;">報表中心</button>
                    </div>

                    <!-- Tab: Profile -->
                    <div id="tab-profile" class="tab-content active">
                        <div class="form-group">
                            <label>大頭貼預覽</label>
                            <div class="avatar-upload-wrapper">
                                <div id="settings-avatar-preview" class="avatar-large">AM</div>
                                <div class="upload-controls">
                                    <label for="avatar-upload" class="btn-secondary">上傳圖片</label>
                                    <input type="file" id="avatar-upload" accept="image/*" hidden>
                                    <button class="btn-text-danger" id="remove-avatar-btn">移除圖片</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>顯示暱稱 (最多3字)</label>
                            <input type="text" id="settings-nickname" class="form-input" maxlength="3"
                                placeholder="例如: Alex">
                        </div>

                        <div class="form-group">
                            <label>修改密碼</label>
                            <input type="password" id="settings-password" class="form-input"
                                placeholder="輸入新密碼 (留空則不修改)">
                        </div>

                        <button id="save-profile-btn" class="btn-primary" style="margin-top: 1rem;">儲存變更</button>
                    </div>

                    <!-- Tab: Team -->
                    <div id="tab-team" class="tab-content">

                        <!-- Team List View -->
                        <div id="team-list-view">
                            <div class="form-group"
                                style="background: #f1f5f9; padding:1rem; border-radius:8px; margin-bottom:1rem; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label style="margin:0; font-weight:700; color:#334155;">管理者模式</label>
                                    <small style="color:#64748b; display:block;">開啟後可幫同事排班</small>
                                </div>
                                <label class="check-group">
                                    <input type="checkbox" id="admin-mode-check">
                                    <span style="font-size:0.9rem;">開啟</span>
                                </label>
                            </div>

                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <p class="hint-text" style="margin:0;">點擊編輯按鈕修改詳細資料</p>
                                <button id="btn-add-member" class="btn-primary"
                                    style="padding:0.4rem 0.8rem; font-size:0.9rem;"><i class="fa-solid fa-plus"></i>
                                    新增同事</button>
                            </div>

                            <ul id="team-settings-list" class="settings-list">
                                <!-- Injected -->
                            </ul>
                        </div>

                        <!-- Member Editor View (Hidden by default) -->
                        <div id="team-member-editor" class="hidden">
                            <div
                                style="display:flex; align-items:center; gap:10px; margin-bottom:1rem; border-bottom:1px solid #e2e8f0; padding-bottom:0.5rem;">
                                <button id="btn-back-team" class="btn-icon"><i
                                        class="fa-solid fa-arrow-left"></i></button>
                                <h3 id="editor-title" style="margin:0;">編輯成員</h3>
                            </div>

                            <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                                <div class="form-group"
                                    style="grid-column: span 2; display:flex; gap:1rem; align-items:center;">
                                    <div id="editor-avatar-preview" class="avatar-large"
                                        style="width:60px; height:60px; font-size:1.5rem;"></div>
                                    <div class="upload-controls">
                                        <label for="editor-avatar-upload" class="btn-secondary"
                                            style="font-size:0.8rem; padding:0.3rem 0.6rem;">換頭像</label>
                                        <input type="file" id="editor-avatar-upload" accept="image/*" hidden>
                                        <button class="btn-text-danger" id="editor-remove-avatar">移除</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>登入帳號 *</label>
                                    <input type="text" id="edit-username" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>登入密碼</label>
                                    <input type="text" id="edit-password" class="form-input" placeholder="保留原密碼">
                                </div>
                                <div class="form-group">
                                    <label>Email (會議通知用)</label>
                                    <input type="email" id="edit-email" class="form-input"
                                        placeholder="example@company.com">
                                </div>
                                <div class="form-group">
                                    <label>中文姓名 *</label>
                                    <input type="text" id="edit-chiname" class="form-input" placeholder="例如: 陳大明">
                                </div>
                                <div class="form-group">
                                    <label>生日</label>
                                    <input type="date" id="edit-birthday" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>顯示暱稱 (列表用)</label>
                                    <input type="text" id="edit-nickname" class="form-input" placeholder="例如: 大明哥">
                                </div>
                                <div class="form-group">
                                    <label>簡稱 (日曆圓點用, 1-2字)</label>
                                    <input type="text" id="edit-shortname" class="form-input" maxlength="2"
                                        placeholder="例如: 明">
                                </div>
                                <div class="form-group">
                                    <label>部門/職稱</label>
                                    <select id="edit-department" class="form-input">
                                        <option value="">(未設定)</option>
                                        <option value="工程部主管">工程部主管</option>
                                        <option value="業務部主管">業務部主管</option>
                                        <option value="客服部主管">客服部主管</option>
                                        <option value="人事主管">人事主管</option>
                                        <option value="工程部職員">工程部職員</option>
                                        <option value="業務專員">業務專員</option>
                                        <option value="客服專員">客服專員</option>
                                        <option value="特助">特助</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>直屬主管</label>
                                    <select id="edit-manager" class="form-input">
                                        <!-- Injected by JS -->
                                    </select>
                                </div>

                                <!-- Geofencing Settings -->
                                <div
                                    style="grid-column: span 2; margin-top: 10px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                                    <label
                                        style="font-weight:bold; color:#1e293b; display:block; margin-bottom:8px;">打卡地點設定
                                        (輸入地址自動抓座標)</label>

                                    <!-- Location 1 -->
                                    <div style="background:#f8fafc; padding:8px; border-radius:8px; margin-bottom:8px;">
                                        <div
                                            style="font-size:0.85rem; font-weight:700; color:#64748b; margin-bottom:4px;">
                                            地點 1</div>
                                        <div
                                            style="display:grid; grid-template-columns: 120px 1fr auto; gap:5px; margin-bottom:5px;">
                                            <input type="text" id="edit-loc1-label" class="form-input"
                                                placeholder="名稱 (如:總部)">
                                            <input type="text" id="edit-loc1-addr" class="form-input"
                                                placeholder="輸入地址 或 貼上座標 (25.x, 121.x)">
                                            <button class="btn-secondary" id="btn-geo-1"
                                                style="font-size:0.8rem; padding:0 8px;"><i
                                                    class="fa-solid fa-location-dot"></i> 抓座標/解析</button>
                                        </div>
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                                            <input type="text" id="edit-loc1-lat" class="form-input"
                                                placeholder="緯度 Lat (可手動輸入)">
                                            <input type="text" id="edit-loc1-lng" class="form-input"
                                                placeholder="經度 Lng (可手動輸入)">
                                        </div>
                                        <div style="text-align:right; margin-top:2px;">
                                            <a href="https://www.google.com/maps" target="_blank"
                                                style="font-size:0.75rem; color:#3b82f6; text-decoration:none;"><i
                                                    class="fa-brands fa-google"></i> 開啟 Google Maps (右鍵複製座標)</a>
                                        </div>
                                    </div>

                                    <!-- Location 2 -->
                                    <div style="background:#f8fafc; padding:8px; border-radius:8px; margin-bottom:8px;">
                                        <div
                                            style="font-size:0.85rem; font-weight:700; color:#64748b; margin-bottom:4px;">
                                            地點 2</div>
                                        <div
                                            style="display:grid; grid-template-columns: 120px 1fr auto; gap:5px; margin-bottom:5px;">
                                            <input type="text" id="edit-loc2-label" class="form-input"
                                                placeholder="名稱 (如:家中)">
                                            <input type="text" id="edit-loc2-addr" class="form-input"
                                                placeholder="輸入地址 或 貼上座標 (25.x, 121.x)">
                                            <button class="btn-secondary" id="btn-geo-2"
                                                style="font-size:0.8rem; padding:0 8px;"><i
                                                    class="fa-solid fa-location-dot"></i> 抓座標/解析</button>
                                        </div>
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                                            <input type="text" id="edit-loc2-lat" class="form-input" placeholder="緯度">
                                            <input type="text" id="edit-loc2-lng" class="form-input" placeholder="經度">
                                        </div>
                                        <div style="text-align:right; margin-top:2px;">
                                            <a href="https://www.google.com/maps" target="_blank"
                                                style="font-size:0.75rem; color:#3b82f6; text-decoration:none;"><i
                                                    class="fa-brands fa-google"></i> 開啟 Google Maps (右鍵複製座標)</a>
                                        </div>
                                    </div>

                                    <!-- Location 3 -->
                                    <div style="background:#f8fafc; padding:8px; border-radius:8px;">
                                        <div
                                            style="font-size:0.85rem; font-weight:700; color:#64748b; margin-bottom:4px;">
                                            地點 3</div>
                                        <div
                                            style="display:grid; grid-template-columns: 120px 1fr auto; gap:5px; margin-bottom:5px;">
                                            <input type="text" id="edit-loc3-label" class="form-input"
                                                placeholder="名稱 (如:客戶A)">
                                            <input type="text" id="edit-loc3-addr" class="form-input"
                                                placeholder="輸入地址 或 貼上座標">
                                            <button class="btn-secondary" id="btn-geo-3"
                                                style="font-size:0.8rem; padding:0 8px;"><i
                                                    class="fa-solid fa-location-dot"></i> 抓座標/解析</button>
                                        </div>
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                                            <input type="text" id="edit-loc3-lat" class="form-input" placeholder="緯度">
                                            <input type="text" id="edit-loc3-lng" class="form-input" placeholder="經度">
                                        </div>
                                        <div style="text-align:right; margin-top:2px;">
                                            <a href="https://www.google.com/maps" target="_blank"
                                                style="font-size:0.75rem; color:#3b82f6; text-decoration:none;"><i
                                                    class="fa-brands fa-google"></i> 開啟 Google Maps (右鍵複製座標)</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>直屬/簽核主管</label>
                                    <select id="edit-manager-select" class="form-input">
                                        <option value="">(無)</option>
                                        <!-- Injected via JS -->
                                    </select>
                                </div>

                                <div class="form-group" style="grid-column: span 2;">
                                    <label>權限設定</label>
                                    <div
                                        style="display: flex; gap: 15px; background: #f8fafc; padding: 10px; border-radius: 6px; flex-wrap: wrap;">
                                        <label class="check-group"><input type="checkbox" id="edit-perm-approve"> <span
                                                style="font-size:0.9rem;">簽核權限 (可看到直屬下屬申請)</span></label>
                                        <label class="check-group"><input type="checkbox" id="edit-perm-schedule"> <span
                                                style="font-size:0.9rem;">排班權限</span></label>
                                        <label class="check-group"><input type="checkbox" id="edit-perm-manage"> <span
                                                style="font-size:0.9rem;">帳號管理</span></label>
                                        <label class="check-group" style="color: #b91c1c;"><input type="checkbox"
                                                id="edit-perm-super"> <span
                                                style="font-size:0.9rem; font-weight:bold;">最大權限 (查看所有申請)</span></label>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:1.5rem; display:flex; gap:10px; justify-content:flex-end;">
                                <button id="btn-delete-member" class="btn-text-danger"
                                    style="margin-right:auto;">刪除此人</button>
                                <button id="btn-cancel-edit" class="btn-secondary">取消</button>
                                <button id="btn-save-member" class="btn-primary">儲存</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Reports -->
                    <div id="tab-reports" class="tab-content">
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top:0; color:#334155; margin-bottom:15px;">出差費用彙整報表</h3>
                            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:end;">
                                <div>
                                    <label
                                        style="display:block; font-size:0.9rem; margin-bottom:5px; font-weight:600;">選擇月份</label>
                                    <div style="display:flex; gap:5px; align-items:center;">
                                        <input type="month" id="report-month-select" class="form-input"
                                            style="width: auto;">
                                        <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"
                                            onclick="changeMonth('report-month-select', -1)">上月</button>
                                        <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"
                                            onclick="changeMonth('report-month-select', 0)">本月</button>
                                        <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"
                                            onclick="changeMonth('report-month-select', 1)">下月</button>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        style="display:block; font-size:0.9rem; margin-bottom:5px; font-weight:600;">選擇人員</label>
                                    <select id="report-user-select" class="form-input" style="min-width:150px;">
                                        <option value="">全部人員</option>
                                    </select>
                                </div>
                                <button id="btn-generate-report" class="btn-primary"><i class="fa-solid fa-table"></i>
                                    產生預覽</button>
                                <button id="btn-export-excel" class="btn-success"
                                    style="background:#15803d; margin-left:auto; display:none;"><i
                                        class="fa-solid fa-file-excel"></i> 匯出 Excel</button>
                            </div>
                        </div>

                        <div id="report-preview-container"
                            style="overflow-x:auto; border:1px solid #e2e8f0; border-radius:8px;">
                            <table class="stats-table" id="report-preview-table" style="min-width: 100%;">
                                <thead>
                                    <tr>
                                        <th>日期</th>
                                        <th>支出</th>
                                        <th>收入</th>
                                        <th style="width:40%;">備註</th>
                                        <th>憑證編號</th>
                                        <th>取得憑證種類</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">
                                            請選擇條件並產生報表</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Backup & Restore Section -->
                    <div id="backup-section" class="settings-section"
                        style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 0.5rem; color: #475569;">📦 資料備份與移轉 (換電腦/換網址用)</h4>
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.8rem;">
                            如果是從舊網址要換到新網址，請先回舊網址按「匯出」，存成檔案後，再來新網址按「匯入」。</p>
                        <div style="display: flex; gap: 8px;">
                            <button id="btn-export-data" class="btn-secondary"
                                style="background: #f1f5f9; border: 1px solid #cbd5e1;"><i
                                    class="fa-solid fa-download"></i> 匯出目前資料</button>
                            <button id="btn-import-data" class="btn-secondary"
                                style="background: #f1f5f9; border: 1px solid #cbd5e1;"><i
                                    class="fa-solid fa-upload"></i> 匯入備份檔案</button>
                            <input type="file" id="import-file-input" style="display: none" accept=".json">
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Applications Modal -->
        <div id="applications-modal" class="modal-overlay" style="align-items: flex-start; padding-top: 2rem;">
            <div class="modal-panel"
                style="max-width: 1200px; width: 95%; height: 90vh; display: flex; flex-direction: column; padding: 0;">
                <div class="modal-header" style="flex-shrink: 0; padding: 1.5rem;">
                    <h2>📋 申請與簽核中心</h2>
                    <button class="btn-close" id="close-applications-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="modal-body" style="flex-grow: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem 1.5rem;">
                    <div class="modal-tabs"
                        style="position: sticky; top: 0; background: white; z-index: 10; padding-top: 10px;">
                        <button class="tab-btn active" data-tab="tab-app-correction">補打卡申請</button>
                        <button class="tab-btn" data-tab="tab-app-expense">出差費申請</button>
                        <button class="tab-btn" data-tab="tab-app-history">申請紀錄/簽核</button>
                    </div>

                    <!-- Tab: Correction -->
                    <div id="tab-app-correction" class="tab-content active"
                        style="max-width: 600px; margin: 0 auto; padding-top: 20px;">
                        <div class="alert-box">
                            <i class="fa-solid fa-circle-info"></i> 申請核准後，系統將自動修正打卡紀錄與報表。
                        </div>
                        <div class="form-group">
                            <label>補卡日期</label>
                            <input type="date" id="app-correct-date" class="form-input">
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:1;">
                                <label>上班時間</label>
                                <input type="time" id="app-correct-in" class="form-input">
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>下班時間</label>
                                <input type="time" id="app-correct-out" class="form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>申請原因</label>
                            <textarea id="app-correct-reason" class="form-input" rows="3"
                                placeholder="例如：忘記打卡、系統異常..."></textarea>
                        </div>
                        <div style="text-align:right;">
                            <button id="btn-submit-correction" class="btn-primary">送出申請</button>
                        </div>
                    </div>

                    <!-- Tab: Expense -->
                    <div id="tab-app-expense" class="tab-content" style="height: 100%;">
                        <div style="display: grid; grid-template-columns: 320px 1fr; gap: 25px; height: 100%;">
                            <!-- Left: Selection Panel -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; height: fit-content;">
                                <h3
                                    style="margin-top: 0; font-size: 1.1rem; color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">
                                    1. 勾選出差日期
                                </h3>
                                <div class="alert-box"
                                    style="margin-bottom: 15px; font-size: 0.9rem; padding: 8px 12px;">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> 勾選後自動帶入事由
                                </div>
                                <div id="app-expense-dates-container"
                                    style="max-height: 250px; overflow-y: auto; background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px;">
                                    <!-- Checkboxes -->
                                </div>
                                <div class="form-group" style="margin-top: 20px;">
                                    <label style="font-weight: 600; color: #475569;">出差事由</label>
                                    <textarea id="app-expense-main-reason" class="form-input" rows="5"
                                        style="resize: vertical;" placeholder="系統自動帶入..."></textarea>
                                </div>
                            </div>

                            <!-- Right: Items Panel -->
                            <div style="display: flex; flex-direction: column;">
                                <h3
                                    style="margin-top: 0; font-size: 1.1rem; color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">
                                    2. 費用明細
                                </h3>

                                <!-- Add Form -->
                                <div
                                    style="background: white; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                                    <div
                                        style="display: grid; grid-template-columns: 140px 110px 130px 1fr 100px 50px; gap: 10px; align-items: end;">
                                        <div>
                                            <label
                                                style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">日期</label>
                                            <select id="exp-item-date" class="form-input" style="width: 100%;">
                                                <option>請先選左側</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">類別</label>
                                            <select id="exp-item-cat" class="form-input" style="width: 100%;">
                                                <option value="traffic">交通費</option>
                                                <option value="accommodation">住宿費</option>
                                                <option value="meal">膳雜費</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">憑證類型</label>
                                            <select id="exp-item-type" class="form-input" style="width: 100%;">
                                                <option value="購票證明">購票證明</option>
                                                <option value="乘車證明">乘車證明</option>
                                                <option value="實體票根">實體票根</option>
                                                <option value="電子發票">電子發票</option>
                                                <option value="收據">收據</option>
                                                <option value="其他">其他</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">說明
                                                (可詳述)</label>
                                            <input type="text" id="exp-item-desc" class="form-input"
                                                style="width: 100%;" placeholder="例如: 高鐵 台北-左營 單程票">
                                        </div>
                                        <div>
                                            <label
                                                style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">金額</label>
                                            <input type="number" id="exp-item-amount" class="form-input"
                                                style="width: 100%; font-family: monospace; font-weight: 700;"
                                                placeholder="$">
                                        </div>
                                        <button id="btn-add-exp-item" class="btn-primary"
                                            style="height: 38px; width: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"><i
                                                class="fa-solid fa-plus"></i></button>
                                    </div>
                                </div>

                                <!-- List -->
                                <div
                                    style="flex-grow: 1; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
                                    <div style="overflow-y: auto; flex-grow: 1;">
                                        <table class="stats-table"
                                            style="margin: 0; border: none; width: 100%; table-layout: fixed;">
                                            <thead style="position: sticky; top: 0; z-index: 5;">
                                                <tr>
                                                    <th style="width: 130px; white-space: nowrap;">日期</th>
                                                    <th style="width: 100px; white-space: nowrap;">類別</th>
                                                    <th>說明</th>
                                                    <th style="width: 120px; white-space: nowrap;">金額</th>
                                                    <th style="width: 60px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="app-expense-items-tbody">
                                                <!-- Dynamic Items -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div
                                        style="background: #f8fafc; padding: 15px 20px; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #64748b; font-size: 0.9rem;">
                                            <i class="fa-solid fa-circle-info"></i> 確認無誤後請送出
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #334155;">
                                            申請總額： <span id="exp-total-display"
                                                style="color: #2563eb; font-size: 1.5rem;">$0</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="text-align: right; margin-top: 20px;">
                                    <button id="btn-generate-pdf" class="btn-secondary"
                                        style="padding: 12px 20px; font-size: 1rem; border-radius: 6px; margin-right: 10px; background: #f1f5f9; border: 1px solid #cbd5e1;">
                                        <i class="fa-solid fa-print"></i> 產生 PDF 報表
                                    </button>
                                    <button id="btn-submit-expense" class="btn-primary"
                                        style="padding: 12px 30px; font-size: 1.1rem; border-radius: 6px;">
                                        <i class="fa-regular fa-paper-plane"></i> 送出申請單
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: History/Approval -->
                    <div id="tab-app-history" class="tab-content" style="padding-top: 20px;">
                        <div class="history-list-container">
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th>類型</th>
                                        <th>申請人/日期</th>
                                        <th>內容詳細</th>
                                        <th>狀態</th>
                                        <th>審核操作</th>
                                    </tr>
                                </thead>
                                <tbody id="app-history-tbody">
                                    <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="js/app.js?v=47"></script>
</body>

</html>